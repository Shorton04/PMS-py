CLEAR: ls_jcds_teco, lv_teco_cancelled, lv_teco_rev_in_window.

SELECT *
  FROM jcds
  INTO ls_jcds_teco
 WHERE objnr = @ps_order-objnr
   AND stat  = 'I0045'
 ORDER BY chgnr DESCENDING
 UP TO 1 ROWS.
ENDSELECT.

IF sy-subrc = 0.

  " Latest TECO status
  lv_teco_active = xsdbool( ls_jcds_teco-inact IS INITIAL ).

  " TECO cancelled
  IF ls_jcds_teco-inact = 'X'.
    lv_teco_cancelled = abap_true.

    IF ( ls_jcds_teco-udate > so_date-low )
    OR ( ls_jcds_teco-udate = so_date-low
     AND ls_jcds_teco-utime >= so_time-low ).
      lv_teco_rev_in_window = abap_true.
    ENDIF.

  ENDIF.

ENDIF.




CLEAR: ls_jcds_lkd, lv_prev_locked, lv_unlock_in_window.

SELECT *
  FROM jcds
  INTO ls_jcds_lkd
 WHERE objnr = @ps_order-objnr
   AND stat  = 'I0043'
 ORDER BY chgnr DESCENDING
 UP TO 1 ROWS.
ENDSELECT.

IF sy-subrc = 0.

  " Latest LOCKED status was removed
  IF ls_jcds_lkd-inact = 'X'.
    lv_prev_locked = abap_true.

    IF ( ls_jcds_lkd-udate > so_date-low )
    OR ( ls_jcds_lkd-udate = so_date-low
     AND ls_jcds_lkd-utime >= so_time-low ).
      lv_unlock_in_window = abap_true.
    ENDIF.

  ENDIF.

ENDIF.