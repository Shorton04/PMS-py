CLEAR: lv_jcds_ts, lv_cdhdr_ts, lv_in_window.

  " === CASE 1: REL orders ===
  IF lv_rel_active = abap_true.


    IF lv_cmxs_active = abap_true.
      " REL with CMXS: Check if header changes (CDHDR) are in window
      SELECT MAX( udate ) AS max_date, MAX( utime ) AS max_time
      INTO ( @lv_chg_date, @lv_chg_time )
      FROM cdhdr
      WHERE objectclas = 'ORDER'
      AND objectid   = @lv_objid
      AND ( ( udate > @so_date-low )
      OR ( udate = @so_date-low AND utime >= @so_time-low ) ).

      IF sy-subrc = 0 AND lv_chg_date IS NOT INITIAL.
        CONCATENATE lv_chg_date lv_chg_time INTO lv_cdhdr_ts.
        lv_in_window = abap_true.
      ENDIF.

    ELSE.
      " REL without CMXS: Always include (no window check needed)
      lv_in_window = abap_true.
    ENDIF.


    " === CASE 2: LOCKED orders ===
  ELSEIF lv_locked_active = abap_true.


    " LOCKED: Check if status change (JCDS) for I0043 is in window
    SELECT MAX( udate ) AS max_date, MAX( utime ) AS max_time
    INTO ( @lv_sts_date, @lv_sts_time )
    FROM jcds
    WHERE objnr = @ps_order-objnr
    AND stat = 'I0043'
    AND ( ( udate > @so_date-low )
    OR ( udate = @so_date-low AND utime >= @so_time-low ) ).

    IF sy-subrc = 0 AND lv_sts_date IS NOT INITIAL.
      CONCATENATE lv_sts_date lv_sts_time INTO lv_jcds_ts.
      lv_in_window = abap_true.
    ENDIF.


    " === CASE 3: TECO orders ===
  ELSEIF lv_teco_active = abap_true.


    " TECO: Check if status change (JCDS) for I0045 is in window
    SELECT MAX( udate ) AS max_date, MAX( utime ) AS max_time
    INTO ( @lv_sts_date, @lv_sts_time )
    FROM jcds
    WHERE objnr = @ps_order-objnr
    AND stat = 'I0045'
    AND ( ( udate > @so_date-low )
    OR ( udate = @so_date-low AND utime >= @so_time-low ) ).

    IF sy-subrc = 0 AND lv_sts_date IS NOT INITIAL.
      CONCATENATE lv_sts_date lv_sts_time INTO lv_jcds_ts.
      lv_in_window = abap_true.
    ENDIF.


  ENDIF.
