DATA: lv_prev_teco TYPE abap_bool,
      lv_prev_rel  TYPE abap_bool.

" Was TECO before?
SELECT SINGLE stat FROM jcds
  WHERE objnr = @ps_order-objnr
    AND stat  = 'I0045'
    AND inact = 'X'
  INTO @DATA(lv_dummy).
IF sy-subrc = 0.
  lv_prev_teco = abap_true.
ENDIF.

" Was REL before?
SELECT SINGLE stat FROM jcds
  WHERE objnr = @ps_order-objnr
    AND stat  = 'I0002'
    AND inact = 'X'
  INTO @lv_dummy.
IF sy-subrc = 0.
  lv_prev_rel = abap_true.
ENDIF.




IF lv_teco_active = abap_true.

  lv_stat = 'I0045'.

  IF lv_cmxs_active = abap_true.
    gs_output-msg = 'TECO – remove CMXS and send to CMX'.
    gs_output-OrderMessageStatus = 'REMOVE_CMXS'.
  ELSE.
    gs_output-msg = 'TECO – CMXS already removed'.
  ENDIF.

  PERFORM f_prepare_output USING ps_order lv_vornr lv_stat.
  APPEND gs_output TO gt_output.
  SORT gt_output BY MaintenanceOrder.
  RETURN.

ENDIF.




IF lv_locked_active = abap_true.

  lv_stat = 'I0043'.

  IF lv_cmxs_active = abap_true.
    gs_output-msg = 'LOCKED – remove CMXS and send to CMX'.
    gs_output-OrderMessageStatus = 'REMOVE_CMXS'.
  ELSE.
    gs_output-msg = 'LOCKED – CMXS already removed'.
  ENDIF.

  PERFORM f_prepare_output USING ps_order lv_vornr lv_stat.
  APPEND gs_output TO gt_output.
  RETURN.

ENDIF.




IF lv_rel_active = abap_true AND lv_prev_teco = abap_true.

  lv_stat = 'I0002'.

  gs_output-msg = 'TECO cancelled – REL restored, send CMXS again'.
  gs_output-OrderMessageStatus = 'ADD_CMXS'.

  PERFORM f_prepare_output USING ps_order lv_vornr lv_stat.
  APPEND gs_output TO gt_output.
  SORT gt_output BY MaintenanceOrder.
  RETURN.

ENDIF.



IF <ls_output_row>-OrderMessageStatus = 'REMOVE_CMXS'.
  APPEND VALUE #( user_st_text = 'CMXS'
                  langu = sy-langu
                  inactive = 'X' ) TO lt_status.
ELSE.
  APPEND VALUE #( user_st_text = 'CMXS'
                  langu = sy-langu ) TO lt_status.
ENDIF.



a
